generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  MANAGER
  DEPUTY
  STAFF
}

enum BedStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  RESERVED
}

enum ShiftStatus {
  DRAFT
  PUBLISHED
  COMPLETED
  CANCELLED
}

enum DemandType {
  FIXED   // requiredStaff is a fixed number
  CENSUS  // requiredStaff is calculated from live bed census
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  role          UserRole  @default(STAFF)
  workspace     Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId   String
  staff         Staff?    @relation(fields: [staffId], references: [id])
  staffId       String?   @unique
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  users     User[]
  staff     Staff[]
  beds           Bed[]
  shifts         Shift[]
  shiftPatterns  ShiftPattern[]
  procedures     Procedure[]
  settings  WorkspaceSettings?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkspaceSettings {
  id              String    @id @default(cuid())
  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId     String    @unique
  minRestHours    Int       @default(11)
  maxOvertime     Int       @default(48)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Staff {
  id            String   @id @default(cuid())
  firstName     String
  lastName      String
  email         String?
  contractHours Int      @default(37)
  role          UserRole @default(STAFF)
  workspace     Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId   String
  user          User?
  SkillToStaff  SkillToStaff[]
  availability  Availability[]
  shifts        Shift[]
  totalHoursThisMonth Float?   @default(0)
  weekendShifts       Int?     @default(0)
  nightShifts         Int?     @default(0)
  rating              Int?     @default(1)
  totalBurden     Float    @default(0)
  StaffBurden     StaffBurden[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Skill {
  id          String   @id @default(cuid())
  name        String   @unique
  SkillToStaff SkillToStaff[]
}

model SkillToStaff {
  staff   Staff  @relation(fields: [staffId], references: [id])
  staffId String
  skill   Skill  @relation(fields: [skillId], references: [id])
  skillId String
  @@id([staffId, skillId])
}

// ─── Procedure Library ────────────────────────────────────────────────────────
model Procedure {
  id              String   @id @default(cuid())
  name            String
  defaultAcuity   Int      @default(2)   // 1-5
  defaultDuration Int      @default(3)   // days
  color           String   @default("#6366f1")
  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId     String
  assignments     BedAssignment[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ─── Bed Management ───────────────────────────────────────────────────────────
model Bed {
  id          String   @id @default(cuid())
  name        String
  room        String?
  isIsolation Boolean  @default(false)
  status      BedStatus @default(AVAILABLE)
  workspace     Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId   String
  assignments BedAssignment[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model BedAssignment {
  id               String     @id @default(cuid())
  bed              Bed        @relation(fields: [bedId], references: [id])
  bedId            String
  patientAcuity    Int        @default(1)
  patientProcedure String?    // Free-text fallback
  procedure        Procedure? @relation(fields: [procedureId], references: [id])
  procedureId      String?    // Optional link to Procedure library
  startTime        DateTime   @default(now())
  endTime          DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
}

// ─── Shift Patterns ───────────────────────────────────────────────────────────
model ShiftPattern {
  id            String     @id @default(cuid())
  name          String
  startTime     String
  endTime       String
  color         String
  requiredStaff Int        @default(1)
  isDefault     Boolean    @default(false)
  demandType    DemandType @default(FIXED)  // FIXED or CENSUS-driven

  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id])

  shifts        Shift[]
  unfairnessWeight Float    @default(1.0)
  targetRating    Float    @default(3.0)
  requiredRole    UserRole @default(STAFF)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([workspaceId, name])
}

model Shift {
  id            String   @id @default(cuid())
  date          DateTime
  patternId     String
  pattern       ShiftPattern @relation(fields: [patternId], references: [id])

  startTime     DateTime
  endTime       DateTime

  staffId       String?
  staff         Staff?   @relation(fields: [staffId], references: [id])

  status        ShiftStatus @default(DRAFT)
  unfairnessWeight Float    @default(1.0)
  targetRating    Float    @default(3.0)
  requiredRole    UserRole @default(STAFF)
  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id])
  StaffBurden   StaffBurden[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model StaffBurden {
  id            String   @id @default(cuid())
  staffId       String
  staff         Staff    @relation(fields: [staffId], references: [id])
  shiftId       String
  shift         Shift    @relation(fields: [shiftId], references: [id])
  burdenValue   Float
  date          DateTime
  createdAt     DateTime @default(now())
}

model Availability {
  id            String   @id @default(cuid())
  staffId       String
  staff         Staff    @relation(fields: [staffId], references: [id])

  type          String
  startDate     DateTime
  endDate       DateTime
  description   String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}